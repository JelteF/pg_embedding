CREATE TABLE t (id integer primary key, val real[]);
select setseed(0.5);
 setseed 
---------
 
(1 row)

INSERT INTO t select id, array[random(), random(), random(), random()] from generate_series(1,1000) id;
CREATE INDEX hnsw_pq_idx ON t USING hnsw (val) WITH (dims=4, m=8, efConstruction=16, efSearch=10, pqBits=3, pqSubqs=2);
CREATE INDEX ON t USING hnsw (val) WITH (dims=4, m=8, efConstruction=16, efSearch=10);
SET enable_seqscan = off;
explain SELECT *,val <-> array[0.5,0.5,0.5,0.5] as dist FROM t ORDER BY dist limit 10;
                                  QUERY PLAN                                   
-------------------------------------------------------------------------------
 Limit  (cost=40.00..40.31 rows=10 width=40)
   ->  Index Scan using t_val_idx on t  (cost=40.00..70.60 rows=1000 width=40)
         Order By: (val <-> '{0.5,0.5,0.5,0.5}'::real[])
(3 rows)

SELECT *,val <-> array[0.5,0.5,0.5,0.5] as dist FROM t ORDER BY dist limit 10;
 id  |                     val                      |    dist    
-----+----------------------------------------------+------------
 400 | {0.46710503,0.4545811,0.45946807,0.5224157}  | 0.07273414
 527 | {0.37684956,0.45730346,0.5250088,0.5357009}  | 0.13743733
 608 | {0.39340326,0.5863226,0.4006322,0.4159442}   | 0.18908674
  56 | {0.5944187,0.42080122,0.56922615,0.36204028} | 0.19751577
 824 | {0.5029616,0.2953276,0.54072964,0.5218371}   | 0.20984596
 413 | {0.4501613,0.52615786,0.29767948,0.5707313}  | 0.22159566
  50 | {0.5823501,0.30808005,0.5093355,0.5794862}   | 0.22365154
 788 | {0.38861075,0.48970208,0.33335614,0.3963874} | 0.22587465
 278 | {0.5278056,0.55817956,0.3298218,0.64159995}  | 0.23058444
 779 | {0.37722898,0.32275072,0.5542112,0.5688836}  | 0.23275274
(10 rows)

SET enable_seqscan = on;
SET enable_indexscan = off;
explain SELECT *,val <-> array[0.5,0.5,0.5,0.5] as dist FROM t ORDER BY dist limit 10;
                            QUERY PLAN                            
------------------------------------------------------------------
 Limit  (cost=44.11..44.13 rows=10 width=40)
   ->  Sort  (cost=44.11..46.61 rows=1000 width=40)
         Sort Key: ((val <-> '{0.5,0.5,0.5,0.5}'::real[]))
         ->  Seq Scan on t  (cost=0.00..22.50 rows=1000 width=40)
(4 rows)

SELECT *,val <-> array[0.5,0.5,0.5,0.5] as dist FROM t ORDER BY dist limit 10;
 id  |                     val                      |    dist    
-----+----------------------------------------------+------------
 400 | {0.46710503,0.4545811,0.45946807,0.5224157}  | 0.07273414
 527 | {0.37684956,0.45730346,0.5250088,0.5357009}  | 0.13743733
 608 | {0.39340326,0.5863226,0.4006322,0.4159442}   | 0.18908674
  56 | {0.5944187,0.42080122,0.56922615,0.36204028} | 0.19751577
 486 | {0.53650695,0.5755203,0.6853818,0.54828215}  | 0.20912594
 824 | {0.5029616,0.2953276,0.54072964,0.5218371}   | 0.20984596
 413 | {0.4501613,0.52615786,0.29767948,0.5707313}  | 0.22159566
  50 | {0.5823501,0.30808005,0.5093355,0.5794862}   | 0.22365154
 788 | {0.38861075,0.48970208,0.33335614,0.3963874} | 0.22587465
 278 | {0.5278056,0.55817956,0.3298218,0.64159995}  | 0.23058444
(10 rows)

drop index hnsw_pq_idx;
CREATE INDEX hnsw_idx ON t USING hnsw (val) WITH (dims=4, m=8, efConstruction=16, efSearch=10);
SELECT *,val <-> array[0.5,0.5,0.5,0.5] as dist FROM t ORDER BY dist limit 10;
 id  |                     val                      |    dist    
-----+----------------------------------------------+------------
 400 | {0.46710503,0.4545811,0.45946807,0.5224157}  | 0.07273414
 527 | {0.37684956,0.45730346,0.5250088,0.5357009}  | 0.13743733
 608 | {0.39340326,0.5863226,0.4006322,0.4159442}   | 0.18908674
  56 | {0.5944187,0.42080122,0.56922615,0.36204028} | 0.19751577
 486 | {0.53650695,0.5755203,0.6853818,0.54828215}  | 0.20912594
 824 | {0.5029616,0.2953276,0.54072964,0.5218371}   | 0.20984596
 413 | {0.4501613,0.52615786,0.29767948,0.5707313}  | 0.22159566
  50 | {0.5823501,0.30808005,0.5093355,0.5794862}   | 0.22365154
 788 | {0.38861075,0.48970208,0.33335614,0.3963874} | 0.22587465
 278 | {0.5278056,0.55817956,0.3298218,0.64159995}  | 0.23058444
(10 rows)

DROP TABLE t;
